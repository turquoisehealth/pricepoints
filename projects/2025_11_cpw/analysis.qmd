---
title: "CPW"
subtitle: "By Dan Snow"
format:
  html:
    fig-format: retina
    fig-dpi: 320
    toc: false
    embed-resources: true
    grid:
      body-width: 900px
execute:
  echo: false
---

```{r setup, message=FALSE}
library(arrow)
library(conflicted)
library(data.table)
library(dplyr)
library(forcats)
library(ggplot2)
library(ggtext)
library(Hmisc)
library(lubridate)
library(patchwork)
library(readr)
library(scales)
library(stringr)
library(tidyr)

# Always use dplyr over other packages
conflict_prefer_all("dplyr", quiet = TRUE)

# Transform numbers into abbreviated amounts
# 100 becomes 100, 1000 becomes 1K, 1000000 becomes $1M, etc.
label_comma_short <- function(x) {
  sapply(
    x,
    function(val) {
      if (is.na(val)) {
        return(NA_character_)
      }

      abs_val <- abs(val)
      sign_str <- ifelse(val < 0, "-", "")
      if (abs_val >= 1e9) {
        paste0(sign_str, round(abs_val / 1e9, 0), "B")
      } else if (abs_val >= 1e6) {
        paste0(sign_str, round(abs_val / 1e6, 0), "M")
      } else if (abs_val >= 1e3) {
        paste0(sign_str, round(abs_val / 1e3, 0), "K")
      } else {
        paste0(sign_str, formatC(abs_val, format = "f", digits = 0))
      }
    },
    USE.NAMES = FALSE
  )
}


# Static set of colors to associate with different factors
color_values <- c(
  "Outpatient" = "#8da0cb",
  "Inpatient" = "#e78ac3",
  "Outpatient-dark" = "#627cb7",
  "Inpatient-dark" = "#c65398"
)
```

```{r load_data, message=FALSE, warning=FALSE}
bswh_inst_sub_df <- read_parquet("data/output/bswh_inst_sub.parquet")
bswh_inst_tq_rates_df <- read_parquet("data/output/bswh_inst_tq_rates.parquet")
bswh_pro_sub_df <- read_parquet("data/output/bswh_pro_sub.parquet")
bswh_pro_tq_rates_df <- read_parquet("data/output/bswh_pro_tq_rates.parquet")
```

```{r inst_payer_boxplot, message=FALSE}
#| column: page
#| out-width: 100%
#| fig-width: 8
#| fig-height: 6.5

bswh_inst_tq_payer_agg_df <- bswh_inst_tq_rates_df |>
  filter(billing_code %in% bswh_inst_sub_df$billing_code) |>
  group_by(payer_id, payer_name) |>
  summarise(
    ymin = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_all,
      probs = 0.10,
      na.rm = TRUE
    ),
    ylower = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_all,
      probs = 0.25,
      na.rm = TRUE
    ),
    ymiddle = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_all,
      probs = 0.50,
      na.rm = TRUE
    ),
    yupper = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_all,
      probs = 0.75,
      na.rm = TRUE
    ),
    ymax = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_all,
      probs = 0.90,
      na.rm = TRUE
    ),
    num_rates = n(),
    num_urates = n_distinct(billing_code, billing_code_type, canonical_rate),
    num_providers = n_distinct(provider_id)
  ) |>
  ungroup()

bswh_inst_cpw_payer_agg_df <- bswh_inst_sub_df |>
  group_by(payer_name, payer_id) |>
  summarize(
    ymin = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.10),
    ylower = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.25),
    ymiddle = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.50),
    yupper = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.75),
    ymax = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.90),
    num_rates = n(),
    num_urates = n_distinct(billing_code, billing_code_type, canonical_rate),
    num_providers = 32 # Count of hospitals listed in the CPW BSW contract
  ) |>
  ungroup()

bind_rows(bswh_inst_tq_payer_agg_df, bswh_inst_cpw_payer_agg_df) |>
  mutate(
    payer_name = case_match(
      payer_name,
      "CPW" ~ "Cost Plus",
      "UnitedHealthcare" ~ "UHC",
      "Baylor Scott & White Health Plan" ~ "BSW Health",
      "Blue Cross Blue Shield of Texas" ~ "BCBSTX",
      .default = payer_name
    ),
    payer_name = fct_reorder(payer_name, ymiddle)
  ) |>
  arrange(payer_name) |>
  mutate(
    payer_name = fct_relabel(
      payer_name,
      \(x) {
        paste0(
          "**",
          case_match(
            payer_name,
            "Cost Plus" ~ "<span style='color:#38599b'>Cost Plus</span>",
            .default = x
          ),
          "**<br>",
          "<span style='font-size:13px'>",
          label_comma_short(num_urates),
          " unique rates</span><br>",
          "<span style='font-size:13px'>",
          case_match(
            payer_name,
            "Cost Plus" ~ "for",
            .default = "from"
          ),
          " ",
          scales::label_comma()(num_providers),
          " providers</span>"
        )
      }
    ),
  ) |>
  ggplot() +
  geom_rect(
    data = tibble(bill_type = "Inpatient"),
    aes(
      xmin = 4.5,
      xmax = 5.5,
      ymin = -0.15,
      ymax = Inf
    ),
    fill = "#38599b",
    alpha = 0.2
  ) +
  geom_boxplot(
    aes(
      ymin = ymin,
      lower = ylower,
      middle = ymiddle,
      upper = yupper,
      ymax = ymax,
      x = payer_name
    ),
    stat = "identity",
    width = 0.6
  ) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    x = "",
    y = "Commercial to Medicare ratio",
    title = paste0(
      "Cost Plus Wellness",
      " has higher rates than most Texas insurers"
    ),
    subtitle = paste0(
      "For Baylor Scott & White providers, Cost Plus likely uses ",
      "a fixed % of Medicare"
    ),
    caption = paste0(
      "Cost Plus box includes only Baylor Scott & White institutional rates ",
      "with at least one equivalent commercial PPO rate from another insurer\n",
      "Medicare baseline rates for Cost Plus billing codes are imputed using ",
      "provider and code-specific Medicare prices, sourced from Turquoise\n",
      "Includes ~",
      label_comma_short(nrow(bswh_inst_tq_rates_df)),
      " total ",
      "rates sourced from Turquoise Health Clear Rates, weighted by code ",
      "utilization and hospital bed count\n",
      "Box plots show weighted quantiles of commercial to Medicare rates ",
      "ratios. Whiskers are 10th and 90th percentiles"
    )
  ) +
  theme_minimal() +
  coord_cartesian(clip = "off", ylim = c(0.9, 5.5)) +
  theme(
    plot.title = element_markdown(
      size = 18,
      face = "bold",
      margin = margin(b = 8, l = -36)
    ),
    plot.subtitle = element_markdown(
      size = 15,
      margin = margin(b = 6, l = -36),
      lineheight = 1.1
    ),
    plot.caption = element_text(
      size = 9.2,
      lineheight = 1.1,
      margin = margin(t = 16)
    ),
    axis.title.x = element_markdown(
      margin = margin(t = 10),
      size = 16,
      face = "bold"
    ),
    axis.title.y = element_text(
      margin = margin(r = 10),
      size = 16,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text.x = element_markdown(
      size = 12,
      margin = margin(t = 2),
      lineheight = 1.1
    ),
    axis.text.y = element_markdown(
      size = 12,
      face = "bold"
    ),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey85"),
    panel.grid.minor.y = element_line(color = "grey90")
  )
```

```{r inst_payer_ipop_boxplot, message=FALSE}
#| column: page
#| out-width: 100%
#| fig-width: 8
#| fig-height: 6.5

bswh_inst_tq_payer_ipop_agg_df <- bswh_inst_tq_rates_df |>
  filter(billing_code %in% bswh_inst_sub_df$billing_code) |>
  group_by(payer_id, payer_name, bill_type) |>
  summarise(
    ymin = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_sep,
      probs = 0.10,
      na.rm = TRUE
    ),
    ylower = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_sep,
      probs = 0.25,
      na.rm = TRUE
    ),
    ymiddle = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_sep,
      probs = 0.50,
      na.rm = TRUE
    ),
    yupper = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_sep,
      probs = 0.75,
      na.rm = TRUE
    ),
    ymax = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = total_beds * state_claims_percentile_sep,
      probs = 0.90,
      na.rm = TRUE
    ),
    num_rates = n(),
    num_urates = n_distinct(billing_code, billing_code_type, canonical_rate),
    num_providers = n_distinct(provider_id)
  ) |>
  ungroup()

bswh_inst_cpw_payer_ipop_agg_df <- bswh_inst_sub_df |>
  group_by(payer_name, payer_id, bill_type) |>
  summarize(
    ymin = wtd.quantile(pct_of_medicare, state_claims_percentile_sep, 0.10),
    ylower = wtd.quantile(pct_of_medicare, state_claims_percentile_sep, 0.25),
    ymiddle = wtd.quantile(pct_of_medicare, state_claims_percentile_sep, 0.50),
    yupper = wtd.quantile(pct_of_medicare, state_claims_percentile_sep, 0.75),
    ymax = wtd.quantile(pct_of_medicare, state_claims_percentile_sep, 0.90),
    num_rates = n(),
    num_urates = n_distinct(billing_code, billing_code_type, canonical_rate),
    num_providers = 32 # Count of hospitals listed in the CPW BSW contract
  ) |>
  ungroup()

bind_rows(bswh_inst_tq_payer_ipop_agg_df, bswh_inst_cpw_payer_ipop_agg_df) |>
  mutate(
    payer_name = case_match(
      payer_name,
      "CPW" ~ "Cost Plus",
      "UnitedHealthcare" ~ "UHC",
      "Baylor Scott & White Health Plan" ~ "BSW Health",
      "Blue Cross Blue Shield of Texas" ~ "BCBSTX",
      .default = payer_name
    ),
    payer_name = factor(
      payer_name,
      levels = c("Cigna", "BSW Health", "UHC", "Aetna", "Cost Plus", "BCBSTX")
    ),
    ymax = pmin(ymax, 5.5)
  ) |>
  arrange(payer_name) |>
  mutate(
    rate_label = paste0(
      paste0(
        paste0(
          "<span style='font-size:13px;color:",
          color_values[paste0(bill_type, "-dark")],
          "'>",
          label_comma_short(num_urates),
          "</span>"
        ),
        collapse = " / "
      ),
      "<span style='font-size:13px'> u. rates</span><br>"
    ),
    providers_label = paste0(
      paste0(scales::label_comma()(num_providers)),
      collapse = " / "
    ),
    .by = payer_name
  ) |>
  mutate(
    payer_label = paste0(
      "**",
      case_match(
        payer_name,
        "Cost Plus" ~ "<span style='color:#38599b'>Cost Plus</span>",
        .default = payer_name
      ),
      "**<br>",
      "<span style='font-size:13px'>",
      rate_label,
      "</span>",
      "<span style='font-size:13px'>",
      providers_label,
      " providers</span>"
    ),
    payer_name = fct_relabel(payer_name, \(x) unique(payer_label))
  ) |>
  ggplot() +
  geom_rect(
    data = tibble(bill_type = "Inpatient"),
    aes(
      xmin = 4.5,
      xmax = 5.5,
      ymin = -0.15,
      ymax = Inf
    ),
    fill = "#38599b",
    alpha = 0.2
  ) +
  geom_boxplot(
    aes(
      ymin = ymin,
      lower = ylower,
      middle = ymiddle,
      upper = yupper,
      ymax = ymax,
      x = payer_name,
      fill = bill_type
    ),
    stat = "identity",
    width = 0.6
  ) +
  scale_y_continuous(labels = label_percent()) +
  scale_fill_manual(values = color_values[1:2]) +
  guides(fill = "none") +
  labs(
    x = "",
    y = "Commercial to Medicare ratio",
    title = paste0(
      "Cost Plus has much less rate variability than other insurers"
    ),
    subtitle = paste0(
      "It also maintains a smaller gap between **<span style='color:",
      color_values["Inpatient-dark"],
      "'>inpatient</span>**",
      " and **<span style='color:",
      color_values["Outpatient-dark"],
      "'>outpatient</span>**",
      " rates"
    ),
    caption = paste0(
      "Cost Plus box includes only Baylor Scott & White institutional rates ",
      "with at least one equivalent commercial PPO rate from another insurer\n",
      "Medicare baseline rates for Cost Plus billing codes are imputed using ",
      "provider and code-specific Medicare prices, sourced from Turquoise\n",
      "Includes ~",
      label_comma_short(nrow(bswh_inst_tq_rates_df)),
      " total ",
      "rates sourced from Turquoise Health Clear Rates, weighted by code ",
      "utilization and hospital bed count\n",
      "Box plots show weighted quantiles of commercial to Medicare rates ",
      "ratios. Whiskers are 10th and 90th percentiles"
    )
  ) +
  theme_minimal() +
  coord_cartesian(clip = "off", ylim = c(0.9, 5.5)) +
  theme(
    plot.title = element_markdown(
      size = 18,
      face = "bold",
      margin = margin(b = 8, l = -36)
    ),
    plot.subtitle = element_markdown(
      size = 15,
      margin = margin(b = 6, l = -36),
      lineheight = 1.1
    ),
    plot.caption = element_text(
      size = 9.2,
      lineheight = 1.1,
      margin = margin(t = 16)
    ),
    axis.title.x = element_markdown(
      margin = margin(t = 10),
      size = 16,
      face = "bold"
    ),
    axis.title.y = element_text(
      margin = margin(r = 10),
      size = 16,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text.x = element_markdown(
      size = 12,
      margin = margin(t = 2),
      lineheight = 1.1
    ),
    axis.text.y = element_markdown(
      size = 12,
      face = "bold"
    ),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey85"),
    panel.grid.minor.y = element_line(color = "grey90")
  )
```

```{r pro_payer_boxplot, message=FALSE}
#| column: page
#| out-width: 100%
#| fig-width: 8
#| fig-height: 6.5

bswh_pro_tq_payer_agg_df <- bswh_pro_tq_rates_df |>
  inner_join(
    bswh_pro_sub_df |> select(billing_code, facility),
    by = c("billing_code", "facility")
  ) |>
  group_by(payer_id, payer_name) |>
  summarise(
    ymin = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = state_claims_percentile_all,
      probs = 0.10,
      na.rm = TRUE
    ),
    ylower = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = state_claims_percentile_all,
      probs = 0.25,
      na.rm = TRUE
    ),
    ymiddle = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = state_claims_percentile_all,
      probs = 0.50,
      na.rm = TRUE
    ),
    yupper = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = state_claims_percentile_all,
      probs = 0.75,
      na.rm = TRUE
    ),
    ymax = wtd.quantile(
      canonical_rate / medicare_rate,
      weights = state_claims_percentile_all,
      probs = 0.90,
      na.rm = TRUE
    ),
    num_rates = n(),
    num_urates = n_distinct(
      billing_code, billing_code_type, canonical_rate, facility
    ),
    num_providers = n_distinct(provider_id)
  ) |>
  ungroup()

bswh_pro_cpw_payer_agg_df <- bswh_pro_sub_df |>
  group_by(payer_name, payer_id) |>
  summarize(
    ymin = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.10),
    ylower = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.25),
    ymiddle = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.50),
    yupper = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.75),
    ymax = wtd.quantile(pct_of_medicare, state_claims_percentile_all, 0.90),
    num_rates = n(),
    num_urates = n_distinct(billing_code, billing_code_type, canonical_rate),
    num_providers = 6 # Count of hospitals listed in the CPW BSW contract
  ) |>
  ungroup()

bind_rows(bswh_pro_tq_payer_agg_df, bswh_pro_cpw_payer_agg_df) |>
  mutate(
    payer_name = case_match(
      payer_name,
      "CPW" ~ "Cost Plus",
      "UnitedHealthcare" ~ "UHC",
      "Baylor Scott & White Health Plan" ~ "BSW Health",
      "Blue Cross Blue Shield of Texas" ~ "BCBSTX",
      .default = payer_name
    ),
    payer_name = fct_reorder(payer_name, ymiddle)
  ) |>
  arrange(payer_name) |>
  mutate(
    payer_name = fct_relabel(
      payer_name,
      \(x) {
        paste0(
          "**",
          case_match(
            payer_name,
            "Cost Plus" ~ "<span style='color:#38599b'>Cost Plus<br>(BSW)</span>",
            .default = x
          ),
          "**<br>",
          "<span style='font-size:13px'>",
          label_comma_short(num_urates),
          " unique rates</span><br>",
          "<span style='font-size:13px'>",
          case_match(
            payer_name,
            "Cost Plus" ~ "for",
            .default = "from"
          ),
          " ",
          scales::label_comma()(num_providers),
          " providers</span>"
        )
      }
    ),
  ) |>
  ggplot() +
  geom_rect(
    data = tibble(bill_type = "Inpatient"),
    aes(
      xmin = 2.5,
      xmax = 3.5,
      ymin = -0.15,
      ymax = Inf
    ),
    fill = "#38599b",
    alpha = 0.2
  ) +
  geom_boxplot(
    aes(
      ymin = ymin,
      lower = ylower,
      middle = ymiddle,
      upper = yupper,
      ymax = ymax,
      x = payer_name
    ),
    stat = "identity",
    width = 0.6
  ) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    x = "",
    y = "Commercial to Medicare ratio",
    title = paste0(
      "Cost Plus ",
      "professional rates are comparable to other insurers"
    ),
    subtitle = paste0(
      "Includes only Baylor Scott & White physician groups. Anesthesia ",
      "codes are excluded"
    ),
    caption = paste0(
      "Cost Plus box includes only Baylor Scott & White professional rates ",
      "with at least one equivalent commercial PPO rate from another insurer\n",
      "Medicare baseline rates for Cost Plus billing codes are imputed using ",
      "provider and code-specific Medicare prices, sourced from Turquoise\n",
      "Professional rates include both facility (roughly 66% of total) ",
      "and non-facility (33%) rates. If a code has both types, then ",
      "both are included\n",
      "Box plots show weighted quantiles of commercial to Medicare rates ",
      "ratios. Whiskers are 10th and 90th percentiles"
    )
  ) +
  theme_minimal() +
  coord_cartesian(clip = "off", ylim = c(0.5, 3.3)) +
  theme(
    plot.title = element_markdown(
      size = 18,
      face = "bold",
      margin = margin(b = 8, l = -36)
    ),
    plot.subtitle = element_markdown(
      size = 14,
      margin = margin(b = 6, l = -36),
      lineheight = 1.1
    ),
    plot.caption = element_text(
      size = 9.2,
      lineheight = 1.1,
      margin = margin(t = 16)
    ),
    axis.title.x = element_markdown(
      margin = margin(t = 10),
      size = 16,
      face = "bold"
    ),
    axis.title.y = element_text(
      margin = margin(r = 10),
      size = 16,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text.x = element_markdown(
      size = 12,
      margin = margin(t = 2),
      lineheight = 1.1
    ),
    axis.text.y = element_markdown(
      size = 12,
      face = "bold"
    ),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey85"),
    panel.grid.minor.y = element_line(color = "grey90")
  )
```
