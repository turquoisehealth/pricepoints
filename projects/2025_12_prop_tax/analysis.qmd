---
title: "340B, consolidation, and property taxes"
subtitle: "By Dan Snow"
format:
  html:
    fig-format: retina
    fig-dpi: 320
    toc: false
    embed-resources: true
    grid:
      body-width: 900px
execute:
  echo: false
---

```{r setup, message=FALSE}
library(arrow)
library(conflicted)
library(data.table)
library(dplyr)
library(forcats)
library(ggplot2)
library(ggspatial)
library(ggtext)
library(Hmisc)
library(lubridate)
library(patchwork)
library(prettymapr)
library(readr)
library(scales)
library(sf)
library(stringr)
library(tidyr)
library(tigris)

# Always use dplyr over other packages
conflict_prefer_all("dplyr", quiet = TRUE)
sf_use_s2(FALSE)

# Transform numbers into abbreviated amounts
# 100 becomes 100, 1000 becomes 1K, 1000000 becomes $1M, etc.
label_comma_short <- function(x) {
  sapply(
    x,
    function(val) {
      if (is.na(val)) {
        return(NA_character_)
      }

      abs_val <- abs(val)
      sign_str <- ifelse(val < 0, "-", "")
      if (abs_val >= 1e9) {
        paste0(sign_str, round(abs_val / 1e9, 0), "B")
      } else if (abs_val >= 1e6) {
        paste0(sign_str, round(abs_val / 1e6, 0), "M")
      } else if (abs_val >= 1e3) {
        paste0(sign_str, round(abs_val / 1e3, 0), "K")
      } else {
        paste0(sign_str, formatC(abs_val, format = "f", digits = 0))
      }
    },
    USE.NAMES = FALSE
  )
}
```

```{r load_data, message=FALSE, warning=FALSE}
macneal_tax_bills_df <- read_parquet("data/output/macneal_tax_bills.parquet")
tax_bill_diff_df <- read_parquet("data/output/tax_bill_diff.parquet")
hospital_info_df <- read_parquet("data/output/hospital_info.parquet")
cost_reports_df <- read_parquet("data/output/cost_reports.parquet")
berwyn_pin_geos_df <- read_parquet("data/output/berwyn_pin_geos.parquet") |>
  st_as_sf(wkt = "geometry", crs = 4326)

state_il_df <- tigris::states(cb = TRUE, year = 2020) |>
  filter(GEOID == "17") |>
  select(name = NAME)
```

```{r macneal_map, message=FALSE, warning=FALSE}
#| column: page
#| out-width: 100%
#| fig-width: 8
#| fig-height: 6

berwyn_inset_bbox <- c(
  xmin = -87.81,
  xmax = -87.782179,
  ymin = 41.82405,
  ymax = 41.836505
) |>
  st_bbox(crs = 4326) |>
  st_as_sfc()

berwyn_map_bbox <- c(
  xmin = -87.8431,
  xmax = -87.731021,
  ymin = 41.787823,
  ymax = 41.886452
) |>
  st_bbox(crs = 4326) |>
  st_as_sfc()

berwyn_inset_plot <- state_il_df |>
  st_transform(4326) |>
  ggplot() +
  geom_sf(
    fill = "grey80",
    color = "grey30"
  ) +
  geom_sf(
    data = berwyn_map_bbox,
    fill = "transparent",
    color = "#961e47",
    linewidth = 1.1
  ) +
  annotate(
    "segment",
    x = -87.85,
    xend = -88.0,
    y = 41.79,
    yend = 41.7,
    color = "#961e47",
    linewidth = 1
  ) +
  annotate(
    "richtext",
    x = -88.0,
    y = 41.5,
    label = "MacNeal<br>Hospital",
    size = 4,
    color = "#961e47",
    fontface = "bold",
    label.color = "transparent",
    fill = "transparent",
    hjust = 1
  ) +
  guides(color = "none") +
  theme_void() +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.border = element_rect(
      color = "black",
      linewidth = 1.1,
      fill = "transparent"
    ),
    plot.margin = margin(r = -20)
  )

berwyn_pin_geos_df |>
  mutate(
    became_exempt = case_match(
      became_exempt,
      TRUE ~ "Became tax-exempt",
      FALSE ~ "Remained taxable",
      .default = NA_character_
    )
  ) |>
  st_intersection(berwyn_inset_bbox) |>
  ggplot() +
  annotation_map_tile(
    "cartolight",
    zoomin = -1
  ) +
  geom_sf(
    aes(fill = became_exempt),
    alpha = 0.8,
    color = "transparent",
    linewidth = 1.1
  ) +
  geom_sf(
    data = berwyn_inset_bbox,
    fill = "transparent",
    color = "transparent"
  ) +
  scale_fill_manual(
    values = c(
      "Became tax-exempt" = "#961e47",
      "Remained taxable" = "grey20"
    ),
    na.value = "transparent",
    na.translate = FALSE
  ) +
  guides(fill = guide_legend(title = "")) +
  labs(
    title = "MacNeal Hospital was acquired by Loyola Medicine in 2018",
    subtitle = paste0(
      "Almost all of MacNeal's previously taxable parcels ",
      "became tax-exempt after the acquisition"
    ),
    caption = paste0(
      "Parcel shapes and tax liability from the ",
      "Cook County Assessor's Office\n",
      "Parcel ownership from parcel mailing address data and ",
      "financial records"
    )
  ) +
  theme_void() +
  theme(
    plot.title = element_text(
      size = 19.75,
      face = "bold",
      margin = margin(b = 8)
    ),
    plot.subtitle = element_markdown(
      size = 13.75,
      margin = margin(b = 8)
    ),
    plot.caption = element_text(
      size = 11,
      lineheight = 1.1,
      margin = margin(t = 12, b = 6)
    ),
    legend.background = element_rect(fill = "white"),
    legend.margin = margin(t = 10, b = 10, r = 10, l = 6),
    legend.position = "inside",
    legend.title.position = "left",
    legend.position.inside = c(0.86, 0.16),
    legend.direction = "vertical",
    legend.key.spacing.y = unit(0.15, "cm"),
    legend.key.size = unit(0.75, "cm"),
    legend.text = element_text(size = 12)
  ) +
  inset_element(
    berwyn_inset_plot,
    left = 0.0,
    right = 0.3,
    top = 1,
    bottom = 0
  ) +
  inset_element(
    ggplot() +
      annotate(
        "text",
        x = 1,
        y = 1,
        label = "Illinois",
        size = 6,
        fontface = "bold",
        color = "grey30"
      ) +
      theme_void(),
    left = 0.0,
    right = 0.35,
    top = -0.08,
    bottom = 0
  )
```

```{r macneal_taxes, message=FALSE}
#| column: page
#| out-width: 100%
#| fig-width: 8
#| fig-height: 6.5

macneal_tax_bills_df |>
  group_by(year) |>
  summarize(final_tax = sum(final_tax)) |>
  mutate(year = make_date(year)) |>
  bind_rows(data.frame(year = rep(make_date(2018, 3, 1), 2))) |>
  arrange(year) |>
  mutate(
    final_tax = approx(
      x = .data$year[!is.na(.data$final_tax)],
      y = .data$final_tax[!is.na(.data$final_tax)],
      xout = year,
      method = "linear"
    )$y
  ) |>
  mutate(
    after_acquisition = year >= make_date(2018, 3, 1) &
      row_number() == max(row_number()),
    .by = year
  ) |>
  ggplot() +
  geom_line(
    aes(x = year, y = final_tax, color = after_acquisition),
    linewidth = 1.1
  ) +
  geom_vline(
    xintercept = make_date(2018, 3),
    color = "grey20",
    linetype = "dashed"
  ) +
  annotate(
    "richtext",
    x = make_date(2018, 1),
    y = 2.75e6,
    label = paste0(
      "Loyola acquires MacNeal Hospital<br>",
      "and applies for tax-exempt status"
    ),
    size = 4,
    hjust = 1,
    label.color = "transparent",
    fill = "transparent"
  ) +
  annotate(
    "richtext",
    x = make_date(2020, 2),
    y = 1.75e6,
    label = paste0(
      "Property taxes are paid in arrears,<br>",
      "so Loyola's exempt status drops<br>",
      "their property tax bill after a year"
    ),
    size = 4,
    hjust = 0,
    label.color = "transparent",
    fill = "transparent"
  ) +
  scale_y_continuous(
    labels = \(x) paste0("$", label_comma_short(x)),
    limits = c(0, 3.6e6)
  ) +
  scale_color_manual(
    values = c(
      "TRUE" = "#d52a63",
      "FALSE" = "grey20"
    ),
    na.value = "transparent",
    na.translate = FALSE
  ) +
  labs(
    title = "MacNeal's property tax bill dropped by ~$2M after acquisition",
    subtitle = "Other taxpayers' bills increased to compensate",
    x = "Date",
    y = "Total property taxes paid"
  ) +
  guides(color = "none") +
  theme_minimal() +
  theme(
    plot.title = element_markdown(
      size = 18,
      face = "bold",
      margin = margin(b = 8, l = -36)
    ),
    plot.subtitle = element_markdown(
      size = 15,
      margin = margin(b = 6, l = -36),
      lineheight = 1.1
    ),
    plot.caption = element_text(
      size = 9.2,
      lineheight = 1.1,
      margin = margin(t = 16)
    ),
    axis.title.x = element_markdown(
      margin = margin(t = 10),
      size = 16,
      face = "bold"
    ),
    axis.title.y = element_text(
      margin = margin(r = 10),
      size = 16,
      lineheight = 1.1,
      face = "bold"
    ),
    axis.text.x = element_markdown(
      size = 14,
      margin = margin(t = 8),
      lineheight = 1.1
    ),
    axis.text.y = element_markdown(
      size = 14,
      margin = margin(r = 8)
    )
  )
```

