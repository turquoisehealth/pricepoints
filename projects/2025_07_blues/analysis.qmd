---
title: "BlueCard Underpayments"
subtitle: "By Dan Snow"
format:
  html:
    fig-format: retina
    fig-dpi: 320
    toc: false
    embed-resources: true
    grid:
      body-width: 900px
execute:
  echo: false
---

```{r setup, message=FALSE}
library(arrow)
library(conflicted)
library(data.table)
library(dplyr)
library(forcats)
library(ggplot2)
library(ggraph)
library(ggrepel)
library(ggridges)
library(ggspatial)
library(ggtext)
library(Hmisc)
library(igraph)
library(lubridate)
library(patchwork)
library(prettymapr)
library(raster)
library(scales)
library(sf)
library(stringr)
library(tidyr)
library(tigris)

# Always use dplyr over other packages
conflict_prefer_all("dplyr", quiet = TRUE)

# Necessary for fast/accurate map rendering
sf_use_s2(FALSE)
options(tigris_use_cache = TRUE)
```

```{r load_data}
blue_rates_df <- read_parquet("data/blue_rates.parquet")
```

```{r}
#| column: page
#| out-width: 100%
#| fig-width: 9
#| fig-height: 7

blue_rates_df |>
  filter(state %in% c("CA", "WA", "PA")) |>
  ggplot() +
  geom_boxplot(aes(x = canonical_rate_diff, y = state), outliers = FALSE)
```

## Plots

- Process flow ala Blue manual diagram
- Single example of underpayment billing, patient centered


- state map of median absolute % difference
- median difference by pair of insurers
- distribution of absolute differences by practice area by state
- Biggest differences by state

- something estimating the volume of the problem
